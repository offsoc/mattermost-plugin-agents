#!/usr/bin/env node

// Script to aggregate evaluation results from multiple LLM providers
// and post/update a unified GitHub PR comment

const fs = require('fs');
const path = require('path');

async function aggregateAndPostResults(github, context) {
    let combinedComment = '## ðŸ¤– LLM Evaluation Results\n\n';

    const resultsDir = 'eval-results';
    const providers = ['eval-results-openai', 'eval-results-anthropic', 'eval-results-azure'];

    let hasAnyResults = false;

    for (const providerDir of providers) {
        const fullPath = path.join(resultsDir, providerDir);

        if (!fs.existsSync(fullPath)) {
            console.log(`Skipping ${providerDir} - directory not found`);
            continue;
        }

        try {
            const providerNamePath = path.join(fullPath, 'provider_name.txt');
            const commentPath = path.join(fullPath, 'comment.md');

            if (fs.existsSync(providerNamePath) && fs.existsSync(commentPath)) {
                const providerName = fs.readFileSync(providerNamePath, 'utf8').trim();
                const commentBody = fs.readFileSync(commentPath, 'utf8').trim();

                if (commentBody) {
                    hasAnyResults = true;
                    console.log(`Processing results for ${providerName}`);
                    combinedComment += `### ${providerName}\n\n`;
                    // Remove the provider-specific header since we have it as a section
                    combinedComment += commentBody.replace(/^## ðŸ¤– .*$/m, '').trim();
                    combinedComment += '\n\n---\n\n';
                }
            } else {
                console.log(`Missing files in ${providerDir}`);
            }
        } catch (error) {
            console.error(`Error processing ${providerDir}:`, error);
        }
    }

    if (!hasAnyResults) {
        combinedComment += 'âš ï¸ No evaluation results were generated for any provider.\n\n';
    }

    combinedComment += '*This comment was automatically generated by the eval CI pipeline.*\n';

    // Find existing comment if any
    const { data: comments } = await github.rest.issues.listComments({
        owner: context.repo.owner,
        repo: context.repo.repo,
        issue_number: context.issue.number,
    });

    const botComment = comments.find(comment =>
        comment.user.type === 'Bot' &&
        comment.body.includes('ðŸ¤– LLM Evaluation Results')
    );

    if (botComment) {
        // Update existing comment
        await github.rest.issues.updateComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            comment_id: botComment.id,
            body: combinedComment
        });
        console.log('âœ… Updated existing comment');
    } else {
        // Create new comment
        await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: combinedComment
        });
        console.log('âœ… Created new comment');
    }
}

module.exports = { aggregateAndPostResults };

